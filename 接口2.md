# 访客地域分布 API 文档

  

## API 信息

  

### 路由地址

```

GET /statistics/visitor/region/list

```

  

### 请求参数

  

| 参数名 | 类型 | 必填 | 说明 |

|--------|------|------|------|

| domain | String | 是 | 域名（如：avmonkey.tv） |

| startDate | Long | 否 | 开始时间戳（毫秒） |

| endDate | Long | 否 | 结束时间戳（毫秒） |

| pageNum | Integer | 否 | 页码，默认 1 |

| pageSize | Integer | 否 | 每页数量，默认 10 |

  

### 请求示例

  

```javascript

// 前端调用示例

const  params = {

domain:  'avmonkey.tv',

startDate:  1729958400000, // 2024-10-27 00:00:00

endDate:  1730563200000, // 2024-11-03 00:00:00

pageNum:  1,

pageSize:  10

}

  

getVisitorRegionList(params).then(res  => {

console.log(res)

})

```

  

### 返回数据结构

  

```json

{

"code": 200,

"msg": "查询成功",

"rows": [

{

"region": "北京",

"province": "北京市",

"visitorCount": 1245,

"percentage": 18.5

},

{

"region": "上海",

"province": "上海市",

"visitorCount": 980,

"percentage": 14.6

},

{

"region": "广东",

"province": "广东省",

"visitorCount": 856,

"percentage": 12.7

},

{

"region": "浙江",

"province": "浙江省",

"visitorCount": 723,

"percentage": 10.8

},

{

"region": "江苏",

"province": "江苏省",

"visitorCount": 654,

"percentage": 9.7

},

{

"region": "四川",

"province": "四川省",

"visitorCount": 543,

"percentage": 8.1

},

{

"region": "湖北",

"province": "湖北省",

"visitorCount": 432,

"percentage": 6.4

},

{

"region": "河南",

"province": "河南省",

"visitorCount": 387,

"percentage": 5.8

},

{

"region": "山东",

"province": "山东省",

"visitorCount": 365,

"percentage": 5.4

},

{

"region": "福建",

"province": "福建省",

"visitorCount": 321,

"percentage": 4.8

}

],

"total": 10

}

```

  

### 字段说明

  

| 字段名 | 类型 | 说明 |

|--------|------|------|

| region | String | 地区简称（如：北京、上海、广东） |

| province | String | 省份全称（如：北京市、上海市、广东省） |

| visitorCount | Integer | 该地区的访客数量 |

| percentage | Double | 该地区访客占总访客的百分比 |

  

### 数据说明

  

1.  **地域识别**：根据访客 IP 地址解析出所在省份/直辖市

2.  **统计周期**：根据 `startDate` 和 `endDate` 参数统计指定时间范围内的数据

3.  **排序规则**：按访客数量降序排列

4.  **返回数量**：默认返回 TOP 10，可通过 `pageSize` 调整

  

### 业务逻辑

  

1. 系统根据传入的 `domain` 和时间范围查询访客数据

2. 对每个访客的 IP 进行地域解析

3. 按省份/直辖市统计访客数量

4. 计算每个地区的访客占比

5. 按访客数量降序排列

6. 返回指定数量的结果

  

### 前端图表展示

  

访客地域分布数据将以**柱状图**的形式展示：

  

-  **X 轴**：地区名称（region）

-  **Y 轴**：访客数量（visitorCount）

-  **标签**：显示访客数和占比（如：1245 (18.5%)）

-  **渐变色**：从蓝色到绿色的渐变填充

-  **Tooltip**：鼠标悬停显示详细信息

  

### 调用时机

  

- 用户切换到"访客分析" Tab 时自动加载

- 根据当前选择的时间周期（日/周/月）动态更新数据

  

### 错误处理

  

如果 API 调用失败，前端会：

1. 显示模拟数据作为降级方案

2. 在控制台输出错误日志

3. 用户仍能看到图表展示（使用模拟数据）

  

### 后端实现建议

  

```java

// 后端 Controller 示例

@GetMapping("/statistics/visitor/region/list")

public  TableDataInfo  getVisitorRegionList(

@RequestParam  String domain,

@RequestParam(required = false) Long startDate,

@RequestParam(required = false) Long endDate,

@RequestParam(defaultValue = "1") Integer pageNum,

@RequestParam(defaultValue = "10") Integer pageSize

) {

// 1. 查询指定域名和时间范围的访客数据

// 2. 根据 IP 解析地域信息

// 3. 按省份统计访客数量

// 4. 计算占比

// 5. 排序并分页返回

List<VisitorRegion> list = visitorService.getRegionStatistics(

domain, startDate, endDate, pageNum, pageSize

);

return  getDataTable(list);

}

```

  

### 数据库设计建议

  

可以考虑在访客记录表中添加地域字段：

  

```sql

ALTER  TABLE visitor_log ADD COLUMN province VARCHAR(50) COMMENT '省份';

ALTER  TABLE visitor_log ADD COLUMN city VARCHAR(50) COMMENT '城市';

ALTER  TABLE visitor_log ADD  INDEX idx_domain_province (domain, province);

```

  

或创建地域统计汇总表：

  

```sql

CREATE  TABLE  visitor_region_stats (

id BIGINT  PRIMARY KEY AUTO_INCREMENT,

domain VARCHAR(255) NOT NULL,

region VARCHAR(50) NOT NULL,

province VARCHAR(50),

visitor_count INT  DEFAULT  0,

percentage  DECIMAL(5,2),

stat_date DATE,

create_time DATETIME,

update_time DATETIME,

INDEX idx_domain_date (domain, stat_date)

) COMMENT='访客地域统计表';

```
<!--stackedit_data:
eyJoaXN0b3J5IjpbLTgyMjgzMzY3OV19
-->