---


---

<ol>
<li>æ£€æŸ¥ 80 ç«¯å£å ç”¨æƒ…å†µ</li>
</ol>
<p>sudo lsof -i :80</p>
<ol start="2">
<li>æš‚æ—¶åœæ­¢å ç”¨ 80 ç«¯å£çš„æœåŠ¡<br>
è¦é‡Šæ”¾ 80 ç«¯å£ï¼Œå¯ä»¥å…ˆåœæ­¢å ç”¨è¯¥ç«¯å£çš„æœåŠ¡ï¼ˆä¾‹å¦‚ nginxï¼‰ã€‚</li>
</ol>
<p>æ‰§è¡Œä»¥ä¸‹å‘½ä»¤åœæ­¢ nginx æœåŠ¡ï¼š</p>
<p>sudo systemctl stop nginx<br>
åœ¨ Ubuntu æˆ– Debian ç³»ç»Ÿä¸­å®‰è£… Certbot<br>
sudo apt update<br>
sudo apt install certbot python3-certbot-nginx</p>
<p>é‡Šæ”¾ 80 ç«¯å£åï¼Œå†æ¬¡è¿è¡Œ certbot å‘½ä»¤ï¼š</p>
<p>sudo certbot certonly --nginx -d www.52ypws.xyz</p>
<p>ä½¿ç”¨ Certbot ç”³è¯·çš„ Letâ€™s Encrypt è¯ä¹¦æœ‰æ•ˆæœŸä¸º 90å¤©ã€‚<br>
Certbot æä¾›è‡ªåŠ¨ç»­æœŸåŠŸèƒ½ï¼Œæ‚¨å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤æ‰‹åŠ¨æµ‹è¯•ç»­æœŸï¼š</p>
<p>sudo certbot renew --dry-run</p>
<p>å¦‚æœæ˜¾ç¤º502é”™è¯¯ï¼Œä¸»è¦æ˜¯å› ä¸º Letâ€™s Encrypt æ— æ³•è®¿é—®ä½ çš„åŸŸåçš„ /.well-known/acme-challenge/ è·¯å¾„ï¼Œå…·ä½“æŠ¥é”™ï¼š<br>
æ£€æŸ¥ DNS è§£ææ˜¯å¦æ­£ç¡®ï¼š<br>
nslookup <a href="http://www.yuep5.com">www.yuep5.com</a><br>
ç¡®ä¿è¿”å›çš„æ˜¯ ä½ çš„æœåŠ¡å™¨ IP åœ°å€ï¼Œè€Œä¸æ˜¯ Cloudflare ä»£ç† IPï¼ˆå¦‚ 2606:4700:3034::ï¼‰ã€‚<br>
å¦‚æœä½¿ç”¨äº† Cloudflareï¼Œå°è¯•å…³é—­ä»£ç† è¿›å…¥ Cloudflare æ§åˆ¶å°ï¼Œæ‰¾åˆ° <a href="http://www.yuep5.com">www.yuep5.com</a> çš„ DNS è®°å½•ï¼Œå°† âš¡(æ©™è‰²äº‘æœµ) å˜æˆ ğŸ”µ(ç°è‰²äº‘æœµ)ï¼ˆå³ â€œDNS Onlyâ€ï¼‰ï¼Œç„¶åå†å°è¯•è·å–è¯ä¹¦ï¼š</p>
<p>æŸ¥çœ‹è¯ä¹¦çš„æœ‰æ•ˆæœŸè¿˜æœ‰å¤šä¹…<br>
openssl x509 -in /etc/letsencrypt/live/www.yuep5.com/fullchain.pem -noout -dates</p>
<p>è®¾ç½®è‡ªåŠ¨ç»­æœŸä»»åŠ¡</p>
<p>åœ¨è®¾ç½® cron è‡ªåŠ¨ç»­æœŸå‰ï¼Œå…ˆæ‰‹åŠ¨æµ‹è¯• certbot ç»­æœŸå‘½ä»¤ï¼š<br>
certbot renew --dry-run<br>
å¦‚æœä¸€åˆ‡æ­£å¸¸ï¼Œä½ ä¼šçœ‹åˆ°ç±»ä¼¼ï¼š<br>
Cert not due for renewal, but simulating renewal for dry run<br>
Congratulations, all renewals succeeded.<br>
å¦‚æœæœ‰é”™è¯¯ï¼Œæ¯”å¦‚ ç«¯å£ 80 è¢«å ç”¨ï¼Œå¯ä»¥å°è¯•ï¼š<br>
certbot renew --nginx --dry-run</p>
<p>ä½¿ç”¨ cron è‡ªåŠ¨ç»­æœŸ</p>
<p>æ£€æŸ¥è¯ä¹¦æœ‰æ•ˆæœŸ<br>
sudo openssl x509 -in /etc/letsencrypt/live/your-domain/fullchain.pem -noout -dates</p>
<p>é…ç½®nginxçš„dockerå·</p>
<pre><code>  - /etc/letsencrypt/live/www.52ypws.xyz:/etc/ssl/nginx
</code></pre>
<p>é…ç½®nginxçš„è®¾ç½®<br>
server {<br>
listen 443;<br>
ssl_certificate /etc/letsencrypt/live/www.52ypws.xyz/fullchain.pem;<br>
ssl_certificate_key /etc/letsencrypt/live/www.52ypws.xyz/privkey.pem;<br>
}</p>
<p>æ¨èçš„è‡ªåŠ¨åŒ–é…ç½®<br>
æŒ‚è½½ /live/ æ–‡ä»¶ï¼š åœ¨ docker-compose.yml ä¸­ï¼Œå§‹ç»ˆä½¿ç”¨ /live/ ä¸­çš„ç¬¦å·é“¾æ¥ï¼š</p>
<p>volumes:</p>
<ul>
<li>/etc/letsencrypt/live/www.52ypws.xyz/fullchain.pem:/etc/ssl/nginx/fullchain.pem:ro</li>
<li>/etc/letsencrypt/live/www.52ypws.xyz/privkey.pem:/etc/ssl/nginx/privkey.pem:ro</li>
</ul>
<p>å¯ç”¨ Letâ€™s Encrypt è‡ªåŠ¨ç»­æœŸï¼š Certbot ä¼šè‡ªåŠ¨æ›´æ–° /live/ ä¸­çš„ç¬¦å·é“¾æ¥ï¼Œç¡®ä¿æŒ‡å‘æœ€æ–°çš„è¯ä¹¦æ–‡ä»¶ã€‚</p>
<p>é‡è½½ Nginxï¼š ä¸ºäº†ä½¿ Nginx ä½¿ç”¨æœ€æ–°çš„è¯ä¹¦ï¼Œå¯ä»¥è®¾ç½®ä¸€ä¸ªè‡ªåŠ¨åŒ–ä»»åŠ¡ï¼Œå®šæœŸæ£€æµ‹è¯ä¹¦æ›´æ–°å¹¶é‡è½½ Nginxã€‚ä¾‹å¦‚ï¼š</p>
<p>certbot renew --post-hook â€œdocker exec nginx nginx -s reloadâ€</p>
<p>liveæŒ‡å‘achiveï¼šsudo ln -s /etc/letsencrypt/archive/www.yuep5.com/cert2.pem cert.pem<br>
sudo ln -s /etc/letsencrypt/archive/www.yuep5.com/chain2.pem chain.pem<br>
sudo ln -s /etc/letsencrypt/archive/www.yuep5.com/fullchain2.pem fullchain.pem<br>
sudo ln -s /etc/letsencrypt/archive/www.yuep5.com/privkey2.pem privkey.pem</p>
<p><strong>ç»­æœŸï¼š</strong><br>
ç¬¬ä¸€æ­¥ï¼šå®‰è£… Certbot</p>
<pre><code>apt update
apt install snapd -y
snap install core
snap refresh core
snap install --classic certbot
ln -s /snap/bin/certbot /usr/bin/certbot
</code></pre>
<p>è¾“å…¥ï¼š</p>
<pre><code>certbot certonly --manual --preferred-challenges=dns -d "*.ypmonkey.space" -d ypmonkey.space
</code></pre>
<p>æŸ¥çœ‹æ³›åŸŸåè¯ä¹¦æ˜¯å¦ç”Ÿæ•ˆï¼Œåœ¨æœ¬åœ°cmdä¸­æŸ¥çœ‹ï¼ˆwindowsï¼‰ï¼š</p>
<pre><code>nslookup -type=TXT _acme-challenge.example.com
</code></pre>
<p>è¿›è¡Œç»­ç­¾ï¼š</p>
<pre><code>docker run -it --rm -v /etc/letsencrypt:/etc/letsencrypt -v /root/.secrets/cf.ini:/etc/letsencrypt/cloudflare.ini:ro certbot/dns-cloudflare certonly --dns-cloudflare --dns-cloudflare-credentials /etc/letsencrypt/cloudflare.ini -d "*.avmonkey.tv" -d "avmonkey.tv"
</code></pre>

