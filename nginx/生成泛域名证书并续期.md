---


---

<ol>
<li>检查 80 端口占用情况</li>
</ol>
<p>sudo lsof -i :80</p>
<ol start="2">
<li>暂时停止占用 80 端口的服务<br>
要释放 80 端口，可以先停止占用该端口的服务（例如 nginx）。</li>
</ol>
<p>执行以下命令停止 nginx 服务：</p>
<p>sudo systemctl stop nginx<br>
在 Ubuntu 或 Debian 系统中安装 Certbot<br>
sudo apt update<br>
sudo apt install certbot python3-certbot-nginx</p>
<p>释放 80 端口后，再次运行 certbot 命令：</p>
<p>sudo certbot certonly --nginx -d www.52ypws.xyz</p>
<p>使用 Certbot 申请的 Let’s Encrypt 证书有效期为 90天。<br>
Certbot 提供自动续期功能，您可以通过以下命令手动测试续期：</p>
<p>sudo certbot renew --dry-run</p>
<p>如果显示502错误，主要是因为 Let’s Encrypt 无法访问你的域名的 /.well-known/acme-challenge/ 路径，具体报错：<br>
检查 DNS 解析是否正确：<br>
nslookup <a href="http://www.yuep5.com">www.yuep5.com</a><br>
确保返回的是 你的服务器 IP 地址，而不是 Cloudflare 代理 IP（如 2606:4700:3034::）。<br>
如果使用了 Cloudflare，尝试关闭代理 进入 Cloudflare 控制台，找到 <a href="http://www.yuep5.com">www.yuep5.com</a> 的 DNS 记录，将 ⚡(橙色云朵) 变成 🔵(灰色云朵)（即 “DNS Only”），然后再尝试获取证书：</p>
<p>查看证书的有效期还有多久<br>
openssl x509 -in /etc/letsencrypt/live/www.yuep5.com/fullchain.pem -noout -dates</p>
<p>设置自动续期任务</p>
<p>在设置 cron 自动续期前，先手动测试 certbot 续期命令：<br>
certbot renew --dry-run<br>
如果一切正常，你会看到类似：<br>
Cert not due for renewal, but simulating renewal for dry run<br>
Congratulations, all renewals succeeded.<br>
如果有错误，比如 端口 80 被占用，可以尝试：<br>
certbot renew --nginx --dry-run</p>
<p>使用 cron 自动续期</p>
<p>检查证书有效期<br>
sudo openssl x509 -in /etc/letsencrypt/live/your-domain/fullchain.pem -noout -dates</p>
<p>配置nginx的docker卷</p>
<pre><code>  - /etc/letsencrypt/live/www.52ypws.xyz:/etc/ssl/nginx
</code></pre>
<p>配置nginx的设置<br>
server {<br>
listen 443;<br>
ssl_certificate /etc/letsencrypt/live/www.52ypws.xyz/fullchain.pem;<br>
ssl_certificate_key /etc/letsencrypt/live/www.52ypws.xyz/privkey.pem;<br>
}</p>
<p>推荐的自动化配置<br>
挂载 /live/ 文件： 在 docker-compose.yml 中，始终使用 /live/ 中的符号链接：</p>
<p>volumes:</p>
<ul>
<li>/etc/letsencrypt/live/www.52ypws.xyz/fullchain.pem:/etc/ssl/nginx/fullchain.pem:ro</li>
<li>/etc/letsencrypt/live/www.52ypws.xyz/privkey.pem:/etc/ssl/nginx/privkey.pem:ro</li>
</ul>
<p>启用 Let’s Encrypt 自动续期： Certbot 会自动更新 /live/ 中的符号链接，确保指向最新的证书文件。</p>
<p>重载 Nginx： 为了使 Nginx 使用最新的证书，可以设置一个自动化任务，定期检测证书更新并重载 Nginx。例如：</p>
<p>certbot renew --post-hook “docker exec nginx nginx -s reload”</p>
<p>live指向achive：sudo ln -s /etc/letsencrypt/archive/www.yuep5.com/cert2.pem cert.pem<br>
sudo ln -s /etc/letsencrypt/archive/www.yuep5.com/chain2.pem chain.pem<br>
sudo ln -s /etc/letsencrypt/archive/www.yuep5.com/fullchain2.pem fullchain.pem<br>
sudo ln -s /etc/letsencrypt/archive/www.yuep5.com/privkey2.pem privkey.pem</p>
<p><strong>续期：</strong><br>
第一步：安装 Certbot</p>
<pre><code>apt update
apt install snapd -y
snap install core
snap refresh core
snap install --classic certbot
ln -s /snap/bin/certbot /usr/bin/certbot
</code></pre>
<p>输入：</p>
<pre><code>certbot certonly --manual --preferred-challenges=dns -d "*.ypmonkey.space" -d ypmonkey.space
</code></pre>
<p>查看泛域名证书是否生效，在本地cmd中查看（windows）：</p>
<pre><code>nslookup -type=TXT _acme-challenge.example.com
</code></pre>
<p>进行续签：</p>
<pre><code>docker run -it --rm -v /etc/letsencrypt:/etc/letsencrypt -v /root/.secrets/cf.ini:/etc/letsencrypt/cloudflare.ini:ro certbot/dns-cloudflare certonly --dns-cloudflare --dns-cloudflare-credentials /etc/letsencrypt/cloudflare.ini -d "*.avmonkey.tv" -d "avmonkey.tv"
</code></pre>

